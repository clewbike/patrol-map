<!doctype html>
<html lang="ja">
<head>
  <meta http-equiv="refresh" content="300">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>電池交換マップ</title>
  <meta name="robots" content="noindex,nofollow">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    /* ✅ 右下の更新日時パネル */
    #legend {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-family: "Segoe UI", "Helvetica Neue", sans-serif;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      z-index: 1000;
      pointer-events: none;
    }

    /* ✅ 左下のクレジット（MapTiler必須・控えめに） */
    #credit {
      position: absolute;
      bottom: 8px;
      left: 8px;
      font-size: 10px;
      color: #ccc;
      background: rgba(0, 0, 0, 0.6);
      padding: 3px 6px;
      border-radius: 6px;
      font-family: "Segoe UI", "Helvetica Neue", sans-serif;
      z-index: 900;
    }
    #credit a {
      color: #ccc;
      text-decoration: none;
    }

    /* ピン情報の小ラベル */
    .badge {
      display: inline-block;
      min-width: 1.6em;
      text-align: center;
      padding: 1px 4px;
      border-radius: 8px;
      background: #eee;
      font-size: 11px;
    }

    /* Leafletのコピーライト非表示 */
    .leaflet-control-attribution { display: none !important; }

    /* 左上：凡例 */
    #legend-box {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-family: "Segoe UI", "Helvetica Neue", sans-serif;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 950;
    }

    /* ズームボタン非表示 */
    .leaflet-control-zoom { display: none !important; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="legend">読み込み中…</div>
  <div id="credit">
    © <a href="https://www.maptiler.com/" target="_blank" rel="noopener">MapTiler</a> /
    © <a href="https://www.openstreetmap.org/" target="_blank" rel="noopener">OpenStreetMap contributors</a>
  </div>

  <div id="legend-box">
    <strong>凡例</strong><br>
    🔴 要交換<br>
    🟠 注意 ⇒ 要交換<br>
    🟡 交換推奨<br>
    🟢 様子見
  </div>

  <script>
    /* ====== 🗺️ マップ初期化 ====== */
    const MAP = L.map('map', { zoomControl:false });

    /* メイン：MapTiler Streets（日本語対応） */
    const maptilerKey = "338nRvmyu8orXOAOfEe6"; // ← あなたのAPIキーを入れてください
    const maptilerLayer = L.tileLayer(
      `https://api.maptiler.com/maps/streets-v2/256/{z}/{x}/{y}.png?key=${maptilerKey}`,
      { maxZoom: 19, attribution: '© MapTiler © OpenStreetMap contributors' }
    );

    /* バックアップ：Carto Light（明るめ） */
    const fallbackLayer = L.tileLayer(
      'https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png',
      { maxZoom: 19, attribution: '© CartoDB' }
    );

    maptilerLayer.addTo(MAP);
    maptilerLayer.on('tileerror', () => {
      console.warn("MapTiler接続失敗：Carto Lightへ切替");
      MAP.removeLayer(maptilerLayer);
      fallbackLayer.addTo(MAP);
    });

    const markersLayer = L.layerGroup().addTo(MAP);

    /* ====== 🎨 色設定（比重に応じて） ====== */
    function colorByWeight(w){
      if (w >= 10) return '#b30000';   // 濃い赤（要交換）
      if (w >= 6)  return '#e34a33';   // 赤（要交換）
      if (w >= 5)  return '#ffcc33';   // 黄（交換推奨）
      if (w >= 3)  return '#a6d96a';   // 薄緑（様子見）
      return null;                     // 1～2以下は非表示
    }

    /* 半径は目安交換台数で調整 */
    function radiusByCount(c){ return Math.max(6, Math.min(22, 6 + (Number(c)||0) * 2)); }

    /* ====== 📦 データ読み込み ====== */
    async function loadData(){
      const res = await fetch('data.json?t=' + Date.now());
      if(!res.ok) throw new Error('data.jsonを取得できません');
      return res.json();
    }

    /* ====== 📍 マーカー描画 ====== */
    function render(data){
      markersLayer.clearLayers();
      const bounds = [];

      (data.items || []).forEach(({lat,lng,name,updated,weight,count}) => {
        const color = colorByWeight(weight);
        if (!color) return; // 1〜2以下は非表示

        const label =
          weight >= 10 ? "要交換" :
          weight >= 6  ? "注意 ⇒ 要交換" :
          weight >= 5  ? "交換推奨" : "様子見";

        const html = `
          <div><strong>${name}</strong></div>
          <div>${label}</div>
          <div>更新: ${updated}</div>
          <div>電池交換比重: <span class="badge">${weight}</span></div>
          <div>目安交換台数: <strong>${count}</strong></div>
          <div style="margin-top:8px">
            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving"
              target="_blank" rel="noopener">車経路（GoogleMAP）</a>
          </div>`;

        const m = L.circleMarker([lat,lng], {
          radius: radiusByCount(count),
          color:'#333',
          weight:1,
          fillColor: color,
          fillOpacity: 0.9
        }).bindPopup(html);

        m.addTo(markersLayer);
        bounds.push([lat,lng]);
      });

      if (bounds.length) {
        MAP.fitBounds(bounds, { padding: [20, 20] });
      } else {
        MAP.setView([35.0, 135.75], 12);
      }

      // 🔹 最新更新日時を取得して右下に表示
      const latest = (data.items || [])
        .map(v => v.updated)
        .filter(Boolean)
        .sort()
        .reverse()[0] || '-';
      document.getElementById('legend').innerHTML = `<strong>更新日時：${latest}</strong>`;
    }

    /* ====== ⏱️ 5分ごとにJSONだけ更新 ====== */
    async function refreshData(){
      try{
        const data = await loadData();
        render(data);
      }catch(e){
        console.error(e);
      }
    }
    refreshData();
    setInterval(refreshData, 5 * 60 * 1000);
  </script>
</body>
</html>
