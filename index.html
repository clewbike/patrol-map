<!doctype html>
<html lang="ja">
<head>
  <meta http-equiv="refresh" content="300">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é›»æ± äº¤æ›ãƒãƒƒãƒ—</title>
  <meta name="robots" content="noindex,nofollow">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    /* âœ… å³ä¸‹ã®æ›´æ–°æ—¥æ™‚ãƒ‘ãƒãƒ« */
    #legend {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-family: "Segoe UI", "Helvetica Neue", sans-serif;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      z-index: 1000;
      pointer-events: none;
    }

    /* âœ… å·¦ä¸‹ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆï¼ˆMapTilerå¿…é ˆãƒ»æ§ãˆã‚ã«ï¼‰ */
    #credit {
      position: absolute;
      bottom: 8px;
      left: 8px;
      font-size: 10px;
      color: #ccc;
      background: rgba(0, 0, 0, 0.6);
      padding: 3px 6px;
      border-radius: 6px;
      font-family: "Segoe UI", "Helvetica Neue", sans-serif;
      z-index: 900;
    }
    #credit a {
      color: #ccc;
      text-decoration: none;
    }

    /* ãƒ”ãƒ³æƒ…å ±ã®å°ãƒ©ãƒ™ãƒ« */
    .badge {
      display: inline-block;
      min-width: 1.6em;
      text-align: center;
      padding: 1px 4px;
      border-radius: 8px;
      background: #eee;
      font-size: 11px;
    }

    /* Leafletã®ã‚³ãƒ”ãƒ¼ãƒ©ã‚¤ãƒˆéè¡¨ç¤º */
    .leaflet-control-attribution { display: none !important; }

    /* å·¦ä¸Šï¼šå‡¡ä¾‹ */
    #legend-box {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-family: "Segoe UI", "Helvetica Neue", sans-serif;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 950;
    }

    /* ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³éè¡¨ç¤º */
    .leaflet-control-zoom { display: none !important; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="legend">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  <div id="credit">
    Â© <a href="https://www.maptiler.com/" target="_blank" rel="noopener">MapTiler</a> /
    Â© <a href="https://www.openstreetmap.org/" target="_blank" rel="noopener">OpenStreetMap contributors</a>
  </div>

  <div id="legend-box">
    <strong>å‡¡ä¾‹</strong><br>
    ğŸ”´ è¦äº¤æ›<br>
    ğŸŸ  æ³¨æ„ â‡’ è¦äº¤æ›<br>
    ğŸŸ¡ äº¤æ›æ¨å¥¨<br>
    ğŸŸ¢ æ§˜å­è¦‹
  </div>

  <script>
    /* ====== ğŸ—ºï¸ ãƒãƒƒãƒ—åˆæœŸåŒ– ====== */
    const MAP = L.map('map', { zoomControl:false });

    /* ãƒ¡ã‚¤ãƒ³ï¼šMapTiler Streetsï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰ */
    const maptilerKey = "338nRvmyu8orXOAOfEe6"; // â† ã‚ãªãŸã®APIã‚­ãƒ¼ã‚’å…¥ã‚Œã¦ãã ã•ã„
    const maptilerLayer = L.tileLayer(
      `https://api.maptiler.com/maps/streets-v2/256/{z}/{x}/{y}.png?key=${maptilerKey}`,
      { maxZoom: 19, attribution: 'Â© MapTiler Â© OpenStreetMap contributors' }
    );

    /* ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šCarto Lightï¼ˆæ˜ã‚‹ã‚ï¼‰ */
    const fallbackLayer = L.tileLayer(
      'https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png',
      { maxZoom: 19, attribution: 'Â© CartoDB' }
    );

    maptilerLayer.addTo(MAP);
    maptilerLayer.on('tileerror', () => {
      console.warn("MapTileræ¥ç¶šå¤±æ•—ï¼šCarto Lightã¸åˆ‡æ›¿");
      MAP.removeLayer(maptilerLayer);
      fallbackLayer.addTo(MAP);
    });

    const markersLayer = L.layerGroup().addTo(MAP);

    /* ====== ğŸ¨ è‰²è¨­å®šï¼ˆæ¯”é‡ã«å¿œã˜ã¦ï¼‰ ====== */
    function colorByWeight(w){
      if (w >= 10) return '#b30000';   // æ¿ƒã„èµ¤ï¼ˆè¦äº¤æ›ï¼‰
      if (w >= 6)  return '#e34a33';   // èµ¤ï¼ˆè¦äº¤æ›ï¼‰
      if (w >= 5)  return '#ffcc33';   // é»„ï¼ˆäº¤æ›æ¨å¥¨ï¼‰
      if (w >= 3)  return '#a6d96a';   // è–„ç·‘ï¼ˆæ§˜å­è¦‹ï¼‰
      return null;                     // 1ï½2ä»¥ä¸‹ã¯éè¡¨ç¤º
    }

    /* åŠå¾„ã¯ç›®å®‰äº¤æ›å°æ•°ã§èª¿æ•´ */
    function radiusByCount(c){ return Math.max(6, Math.min(22, 6 + (Number(c)||0) * 2)); }

    /* ====== ğŸ“¦ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ====== */
    async function loadData(){
      const res = await fetch('data.json?t=' + Date.now());
      if(!res.ok) throw new Error('data.jsonã‚’å–å¾—ã§ãã¾ã›ã‚“');
      return res.json();
    }

    /* ====== ğŸ“ ãƒãƒ¼ã‚«ãƒ¼æç”» ====== */
    function render(data){
      markersLayer.clearLayers();
      const bounds = [];

      (data.items || []).forEach(({lat,lng,name,updated,weight,count}) => {
        const color = colorByWeight(weight);
        if (!color) return; // 1ã€œ2ä»¥ä¸‹ã¯éè¡¨ç¤º

        const label =
          weight >= 10 ? "è¦äº¤æ›" :
          weight >= 6  ? "æ³¨æ„ â‡’ è¦äº¤æ›" :
          weight >= 5  ? "äº¤æ›æ¨å¥¨" : "æ§˜å­è¦‹";

        const html = `
          <div><strong>${name}</strong></div>
          <div>${label}</div>
          <div>æ›´æ–°: ${updated}</div>
          <div>é›»æ± äº¤æ›æ¯”é‡: <span class="badge">${weight}</span></div>
          <div>ç›®å®‰äº¤æ›å°æ•°: <strong>${count}</strong></div>
          <div style="margin-top:8px">
            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving"
              target="_blank" rel="noopener">è»ŠçµŒè·¯ï¼ˆGoogleMAPï¼‰</a>
          </div>`;

        const m = L.circleMarker([lat,lng], {
          radius: radiusByCount(count),
          color:'#333',
          weight:1,
          fillColor: color,
          fillOpacity: 0.9
        }).bindPopup(html);

        m.addTo(markersLayer);
        bounds.push([lat,lng]);
      });

      if (bounds.length) {
        MAP.fitBounds(bounds, { padding: [20, 20] });
      } else {
        MAP.setView([35.0, 135.75], 12);
      }

      // ğŸ”¹ æœ€æ–°æ›´æ–°æ—¥æ™‚ã‚’å–å¾—ã—ã¦å³ä¸‹ã«è¡¨ç¤º
      const latest = (data.items || [])
        .map(v => v.updated)
        .filter(Boolean)
        .sort()
        .reverse()[0] || '-';
      document.getElementById('legend').innerHTML = `<strong>æ›´æ–°æ—¥æ™‚ï¼š${latest}</strong>`;
    }

    /* ====== â±ï¸ 5åˆ†ã”ã¨ã«JSONã ã‘æ›´æ–° ====== */
    async function refreshData(){
      try{
        const data = await loadData();
        render(data);
      }catch(e){
        console.error(e);
      }
    }
    refreshData();
    setInterval(refreshData, 5 * 60 * 1000);
  </script>
</body>
</html>
